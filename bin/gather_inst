#!/usr/bin/env python
import logging

import bs4
import pymongo
from bs4 import BeautifulSoup

from jcvmutils.utils import MongoConnection

log = logging.getLogger(__file__)
handler = logging.StreamHandler()
formatter = logging.Formatter('%(levelname)s:%(asctime)s:%(name)s: %(message)s')
handler.setFormatter(formatter)
log.addHandler(handler)
LOG_LEVELS = [
    logging.DEBUG, logging.INFO, logging.WARNING,
    logging.ERROR, logging.CRITICAL
]


with open('/home/qup/projects/fi/thesis/readings/java-card-docs/specs/jc_specification/specs/jcvm/html/JCVM07instr.html', 'r') as f:
    data = f.read()

soup = BeautifulSoup(data, 'html.parser')


def main():
    for tag in soup.findAll('h3', attrs={'class':'Head2'}):
        data = [tag.text]
        tag = tag.nextSibling
        while True:
            if isinstance(tag, bs4.element.Tag):
                if 'class' in tag.attrs:
                    if 'Head2' in tag.attrs['class'] or 'footnotes' in tag.attrs['class']:
                        process_inst(data)
                        break

                data.append(tag.text)
                tag = tag.nextSibling
            else:
                tag = tag.nextSibling

def process_inst(inst_lines):
    record = {}
    lines = [l.strip() for l in inst_lines]
    lines = [l for l in lines if l]
    xlines = lines[:]
    section, name = lines[0].split()
    # name
    record['name'] = name.strip()
    # section
    record['section'] = section.strip()
    lines = iter(lines[1:])
    # short description
    record['short-description'] = next(lines)
    current = next(lines)

    formats, lines = read_while('Forms', lines)
    record['format'] = formats

    forms, lines = read_while('Stack', lines)
    record['forms'] = forms

    stacks, lines = read_while('Description', lines)
    record['stack'] = stacks

    desc, lines = read_while('Runtime Exceptions', lines)
    record['description'] = desc

    excp, lines = read_while('Notes', lines)
    record['runtime-exceptions'] = excp

    nots, lines = read_while(None, lines)
    record['notes'] = nots

    with MongoConnection(collation='bytecode-instructions') as c:
        c.col.insert_one(record)

    print(record)
    return lines

def read_while(stopper, lines):
    result = []
    if lines is None:
        return result, None
    lines = iter(lines)
    try:
        x = next(lines)
    except StopIteration:
        return result, None
    while x != stopper:
        result.append(x)
        try:
            x = next(lines)
        except StopIteration:
            return result, None

    return result, lines


if __name__ == '__main__':
    main()
